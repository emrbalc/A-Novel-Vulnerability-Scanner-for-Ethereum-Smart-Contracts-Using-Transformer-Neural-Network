import os
import subprocess
from os import listdir
from os.path import isfile, join
import csv
import sys
import io
import re
import pandas as pd
from pandas import *
from openpyxl import Workbook
from openpyxl import load_workbook



mypath = join(os.path.expanduser('~'), 'MAIAN', 'tool', 'contractFolder')
opcodeExcelPath = join(os.path.expanduser('~'), 'MAIAN', 'tool', 'opcodes.xlsx')
xlsxPath = join(os.path.expanduser('~'), 'MAIAN', 'tool', 'evmMapping.xls')
onlyfiles = [f for f in listdir(mypath) if isfile(join(mypath, f))]
xlsx = ExcelFile(xlsxPath)
df = xlsx.parse(xlsx.sheet_names[0])
print(df)
evmMappingDictionary = df.set_index('Key').to_dict()['Value']

print(evmMappingDictionary)
count = 0
for file in onlyfiles:
    address_name = file.split("_")
    rawOpcode = subprocess.Popen('solc --opcodes ' + mypath + '/' + file, shell=True, stdout=subprocess.PIPE)
    opcode = rawOpcode.communicate()  
    opcode = str(opcode).strip()
    opcode = re.sub("\(b'", "",str(opcode))
    opcode = re.sub('=======.*?Opcodes:', "",str(opcode),flags=re.DOTALL)
    opcode = re.sub("\n", "",str(opcode))
    opcode = re.sub("', None\)", "",str(opcode))    
    for element in opcode.split(" "):       
        if any(x == str(element) for x in evmMappingDictionary.keys()):
           # print("CONTAINED ELEMENT", element);           
           opcode = opcode.replace(str(element), str(evmMappingDictionary.get(element)))
        else: 
           # print("not CONTAINED ELEMENT", element);
           opcode = opcode.replace(element, "")

    new_row = [address_name[0], opcode]
    wb = load_workbook(opcodeExcelPath)
    ws = wb.worksheets[0]
    ws.append(new_row)
    wb.save(opcodeExcelPath)
    count = count + 1
    print("count", count); 